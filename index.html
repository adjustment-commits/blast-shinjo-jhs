<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BLASTスイング記録｜中学校野球部</title>
<style>
body {
  font-family: "Noto Sans JP", sans-serif;
  background: #fff;
  color: #222;
  margin: 0;
  padding: 10px;
}
h1 {
  text-align: center;
  color: #009e60;
  margin: 10px 0 20px;
  font-size: 1.4rem;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}
th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}
th {
  background: #e8f5e9;
  color: #006b4b;
  position: sticky;
  top: 0;
}
input {
  width: 90%;
  padding: 4px;
  text-align: center;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 0.9rem;
}
.comment {
  font-size: 0.8rem;
  text-align: left;
}
button {
  background: #009e60;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  margin-top: 10px;
}
button:hover { background: #00784a; }
#container {
  max-width: 900px;
  margin: auto;
  overflow-x: hidden;
}
tr.year2 td:first-child { background: #f3fbf5; font-weight: bold; }
tr.year1 td:first-child { background: #f9fdfb; font-weight: bold; }
#averageBox {
  text-align: center;
  margin-top: 15px;
  font-weight: bold;
  color: #006b4b;
  line-height: 1.8;
  transition: color 0.3s;
}
.high { color: #009e60; }
.mid { color: #333333; }
.low { color: #d62828; }
#chart {
  margin: 20px auto;
  display: block;
  width: 90%;
  max-width: 400px;
  height: 200px;
}
</style>
</head>
<body>
<div id="container">
  <h1>BLASTスイング記録（中学校野球部）</h1>

  <table id="blastTable">
    <thead>
      <tr>
        <th>学年・氏名</th>
        <th>Bat Speed<br>(km/h)</th>
        <th>Attack Angle<br>(°)</th>
        <th>参考ヘッドスピード<br>(推定値 km/h)</th>
        <th>コメント</th>
      </tr>
    </thead>
    <tbody>
      <!-- 19名分（省略可：前回のまま） -->
    </tbody>
  </table>

  <div id="averageBox">
    <span id="avgAll" class="mid">全体平均：-- km/h　｜　参考：-- km/h</span><br>
    <span id="avg2" class="mid">2年平均：-- km/h</span>　｜　
    <span id="avg1" class="mid">1年平均：-- km/h</span>
  </div>

  <canvas id="chart"></canvas>

  <div style="text-align:center;">
    <button onclick="downloadCSV()">CSVダウンロード</button>
  </div>
</div>

<script>
const ctx = document.getElementById("chart").getContext("2d");

document.querySelectorAll(".batSpeed, .attackAngle").forEach(input => {
  input.addEventListener("input", e => {
    const row = e.target.closest("tr");
    updateRow(row);
    updateAverages();
  });
});

function updateRow(row) {
  const batSpeed = parseFloat(row.querySelector(".batSpeed").value);
  const attack = parseFloat(row.querySelector(".attackAngle").value);
  const refCell = row.querySelector(".refSpeed");
  const commentCell = row.querySelector(".comment");

  if (!isNaN(batSpeed)) refCell.textContent = (batSpeed * 1.6).toFixed(1);
  else refCell.textContent = "-";

  if (!isNaN(batSpeed) && !isNaN(attack))
    commentCell.textContent = evaluate(batSpeed, attack);
  else commentCell.textContent = "-";
}

function evaluate(batSpeed, attack) {
  let out = "";
  if (batSpeed < 60) out += "出力不足（下半身の連動強化が必要）";
  else if (batSpeed <= 70) out += "平均的（スイング順序とタイミングを整える段階）";
  else if (batSpeed <= 80) out += "良好（出力が安定。角度制御と再現性を重視）";
  else out += "高出力（角度とのバランスとコンタクト精度を磨く）";
  out += " ／ ";
  if (attack < 0) out += "ダウン傾向（下半身主導の不足または早開き）";
  else if (attack <= 12) out += "理想的（ミート率・打球効率良好）";
  else if (attack <= 18) out += "強打者型（長打志向。出力とのバランス要確認）";
  else out += "アッパー傾向（リリース遅れまたは上体主導）";
  return out;
}

function updateAverages() {
  const avg = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : "--";
  const all = Array.from(document.querySelectorAll(".batSpeed")).map(i=>parseFloat(i.value)).filter(v=>!isNaN(v));
  const y2 = Array.from(document.querySelectorAll(".year2 .batSpeed")).map(i=>parseFloat(i.value)).filter(v=>!isNaN(v));
  const y1 = Array.from(document.querySelectorAll(".year1 .batSpeed")).map(i=>parseFloat(i.value)).filter(v=>!isNaN(v));
  const avgAll = avg(all), avg2 = avg(y2), avg1 = avg(y1);
  const avgRef = avgAll !== "--" ? (avgAll*1.6).toFixed(1) : "--";

  colorize("avgAll", avgAll);
  colorize("avg2", avg2);
  colorize("avg1", avg1);

  document.getElementById("avgAll").innerHTML = `全体平均：${avgAll} km/h　｜　参考：${avgRef} km/h`;
  document.getElementById("avg2").innerHTML = `2年平均：${avg2} km/h`;
  document.getElementById("avg1").innerHTML = `1年平均：${avg1} km/h`;

  drawChart(avgAll, avg2, avg1);
}

function colorize(id, val) {
  const el = document.getElementById(id);
  el.className = "mid";
  const v = parseFloat(val);
  if (isNaN(v)) return;
  if (v >= 80) el.className = "high";
  else if (v < 70) el.className = "low";
}

function drawChart(all, y2, y1) {
  const values = [parseFloat(y2) || 0, parseFloat(y1) || 0, parseFloat(all) || 0];
  const labels = ["2年", "1年", "全体"];
  const colors = values.map(v => v >= 80 ? "#009e60" : v >= 70 ? "#333" : "#d62828");
  const maxVal = Math.max(...values, 100);

  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  const width = ctx.canvas.width / 5;
  const scale = (ctx.canvas.height - 30) / maxVal;

  values.forEach((v, i) => {
    const barHeight = v * scale;
    const x = (i + 1) * width;
    const y = ctx.canvas.height - barHeight - 10;
    ctx.fillStyle = colors[i];
    ctx.fillRect(x, y, width / 2, barHeight);
    ctx.fillStyle = "#000";
    ctx.textAlign = "center";
    ctx.font = "14px sans-serif";
    ctx.fillText(labels[i], x + width / 4, ctx.canvas.height - 2);
    if (v > 0) ctx.fillText(v.toFixed(1), x + width / 4, y - 5);
  });
}

function downloadCSV() {
  let csv = "学年・氏名,BatSpeed(km/h),AttackAngle(°),参考ヘッドスピード(km/h),コメント\n";
  document.querySelectorAll("#blastTable tbody tr").forEach(row=>{
    const cols = row.querySelectorAll("td");
    const name = cols[0].querySelector("input").value;
    const bs = cols[1].querySelector("input").value;
    const aa = cols[2].querySelector("input").value;
    const ref = cols[3].textContent;
    const com = cols[4].textContent.replace(/,/g,"、");
    csv += `${name},${bs},${aa},${ref},"${com}"\n`;
  });
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "blast_record.csv";
  link.click();
}
</script>
</body>
</html>
