<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BLASTスイング記録｜新庄中野球部</title>

<!-- ✅ PWA対応設定 -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#009e60">
<link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BLAST記録">
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js');
  });
}
</script>

<style>
body {
  font-family: "Noto Sans JP", sans-serif;
  background: #fff;
  color: #222;
  margin: 0;
  padding: 10px;
}
h1 {
  text-align: center;
  color: #009e60;
  margin: 10px 0 20px;
  font-size: 1.4rem;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}
th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}
th {
  background: #e8f5e9;
  color: #006b4b;
  position: sticky;
  top: 0;
}
input {
  width: 90%;
  padding: 4px;
  text-align: center;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 0.9rem;
}
.comment {
  font-size: 0.8rem;
  text-align: left;
}
button {
  background: #009e60;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  margin-top: 10px;
}
button:hover { background: #00784a; }
#container {
  max-width: 950px;
  margin: auto;
  overflow-x: hidden;
}
tr.year2 td:first-child { background: #f3fbf5; font-weight: bold; }
tr.year1 td:first-child { background: #f9fdfb; font-weight: bold; }
#averageBox {
  text-align: center;
  margin-top: 15px;
  font-weight: bold;
  color: #006b4b;
  line-height: 1.8;
  transition: color 0.3s;
}
.high { color: #009e60; }
.mid { color: #333333; }
.low { color: #d62828; }
#chart {
  margin: 20px auto;
  display: block;
  width: 90%;
  max-width: 420px;
  height: 200px;
}
</style>
</head>

<body>
<div id="container">
  <h1>BLASTスイング記録（新庄中野球部）</h1>

  <table id="blastTable">
    <thead>
      <tr>
        <th>学年・氏名</th>
        <th>Bat Speed<br>(km/h)</th>
        <th>Attack Angle<br>(°)</th>
        <th>Time to Contact<br>(s)</th>
        <th>参考ヘッドスピード<br>(推定値 km/h)</th>
        <th>コメント</th>
      </tr>
    </thead>
    <tbody>

        <!-- 2年生 -->
      <tr class="year2"><td><input type="text" value="2年 石井" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year2"><td><input type="text" value="2年 黒田" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year2"><td><input type="text" value="2年 黒畑" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year2"><td><input type="text" value="2年 齋藤" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year2"><td><input type="text" value="2年 高倉" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year2"><td><input type="text" value="2年 西井" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year2"><td><input type="text" value="2年 二宮" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year2"><td><input type="text" value="2年 堀井" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year2"><td><input type="text" value="2年 山本" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>

      <!-- 1年生 -->
      <tr class="year1"><td><input type="text" value="1年 荒井" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year1"><td><input type="text" value="1年 浦上" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year1"><td><input type="text" value="1年 瓜生" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year1"><td><input type="text" value="1年 管" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year1"><td><input type="text" value="1年 新川" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year1"><td><input type="text" value="1年 須原" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year1"><td><input type="text" value="1年 芹田" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year1"><td><input type="text" value="1年 古田" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year1"><td><input type="text" value="1年 鈴木" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
      <tr class="year1"><td><input type="text" value="1年 豊本" readonly></td><td><input type="number" step="0.1" class="batSpeed"></td><td><input type="number" step="0.1" class="attackAngle"></td><td><input type="number" step="0.001" class="timeContact"></td><td class="refSpeed">-</td><td class="comment">-</td></tr>
    </tbody>
  </table>

  <div id="averageBox">
    <span id="avgAll" class="mid">全体平均：-- km/h　｜　参考：-- km/h</span><br>
    <span id="avg2" class="mid">2年平均：-- km/h</span>　｜　
    <span id="avg1" class="mid">1年平均：-- km/h</span>
  </div>

  <canvas id="chart"></canvas>

  <div style="text-align:center;">
    <button onclick="downloadCSV()">CSVダウンロード</button>
  </div>
</div>

<script>
const ctx = document.getElementById("chart").getContext("2d");

document.querySelectorAll(".batSpeed, .attackAngle, .timeContact").forEach(input => {
  input.addEventListener("input", e => {
    const row = e.target.closest("tr");
    updateRow(row);
    updateAverages();
  });
});

function updateRow(row) {
  const batSpeed = parseFloat(row.querySelector(".batSpeed").value);
  const attack = parseFloat(row.querySelector(".attackAngle").value);
  const ttc = parseFloat(row.querySelector(".timeContact").value);
  const refCell = row.querySelector(".refSpeed");
  const commentCell = row.querySelector(".comment");

  if (!isNaN(batSpeed)) refCell.textContent = (batSpeed * 1.6).toFixed(1);
  else refCell.textContent = "-";

  if (!isNaN(batSpeed) && !isNaN(attack))
    commentCell.textContent = evaluate(batSpeed, attack, ttc);
  else commentCell.textContent = "-";
}

function evaluate(batSpeed, attack, ttc) {
  let out = "";

  // Bat Speed
  if (batSpeed < 65) out += "出力不足（下半身と体幹の連動が弱く、打球初速が上がりにくい）";
  else if (batSpeed < 75) out += "平均以下（スイング速度はあるが、力をボールに伝え切れていない）";
  else if (batSpeed < 85) out += "平均的（動作の再現性とタイミング精度を高めたい）";
  else out += "上位水準（出力は十分。角度とコンタクト精度を安定させたい）";

  out += " ／ ";

  // Attack Angle
  if (attack < -3) out += "極端なダウン軌道（インパクトロスが大きい）";
  else if (attack < 5) out += "ややダウン傾向（下方向への力が強く、ロスが出ている）";
  else if (attack <= 12) out += "理想範囲（効率的な軌道。動作の再現性を維持したい）";
  else if (attack <= 18) out += "ややアッパー（強打志向。下半身主導の維持が課題）";
  else out += "過度なアッパー（上体主導。再現性が低下している）";

  // Time to Contact
  if (!isNaN(ttc)) {
    out += " ／ ";
    if (ttc > 0.18) out += "始動が遅く、出力伝達に時間を要している";
    else if (ttc > 0.16) out += "平均的。動作順序の安定が課題";
    else if (ttc > 0.14) out += "反応速度は良好。出力方向との一致を高めたい";
    else out += "反応は速い。動作精度を維持できるかが鍵";
  }

  return out;
}

function updateAverages() {
  const avg = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : "--";
  const all = Array.from(document.querySelectorAll(".batSpeed")).map(i=>parseFloat(i.value)).filter(v=>!isNaN(v));
  const y2 = Array.from(document.querySelectorAll(".year2 .batSpeed")).map(i=>parseFloat(i.value)).filter(v=>!isNaN(v));
  const y1 = Array.from(document.querySelectorAll(".year1 .batSpeed")).map(i=>parseFloat(i.value)).filter(v=>!isNaN(v));
  const avgAll = avg(all), avg2 = avg(y2), avg1 = avg(y1);
  const avgRef = avgAll !== "--" ? (avgAll*1.6).toFixed(1) : "--";

  colorize("avgAll", avgAll);
  colorize("avg2", avg2);
  colorize("avg1", avg1);

  document.getElementById("avgAll").innerHTML = `全体平均：${avgAll} km/h　｜　参考：${avgRef} km/h`;
  document.getElementById("avg2").innerHTML = `2年平均：${avg2} km/h`;
  document.getElementById("avg1").innerHTML = `1年平均：${avg1} km/h`;

  drawChart(avgAll, avg2, avg1);
}

function colorize(id, val) {
  const el = document.getElementById(id);
  el.className = "mid";
  const v = parseFloat(val);
  if (isNaN(v)) return;
  if (v >= 80) el.className = "high";
  else if (v < 70) el.className = "low";
}

function drawChart(all, y2, y1) {
  const values = [parseFloat(y2) || 0, parseFloat(y1) || 0, parseFloat(all) || 0];
  const labels = ["2年", "1年", "全体"];
  const colors = values.map(v => v >= 80 ? "#009e60" : v >= 70 ? "#333" : "#d62828");
  const maxVal = Math.max(...values, 100);

  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  const width = ctx.canvas.width / 5;
  const scale = (ctx.canvas.height - 30) / maxVal;

  values.forEach((v, i) => {
    const barHeight = v * scale;
    const x = (i + 1) * width;
    const y = ctx.canvas.height - barHeight - 10;
    ctx.fillStyle = colors[i];
    ctx.fillRect(x, y, width / 2, barHeight);
    ctx.fillStyle = "#000";
    ctx.textAlign = "center";
    ctx.font = "14px sans-serif";
    ctx.fillText(labels[i], x + width / 4, ctx.canvas.height - 2);
    if (v > 0) ctx.fillText(v.toFixed(1), x + width / 4, y - 5);
  });
}

function downloadCSV() {
  let csv = "学年・氏名,BatSpeed(km/h),AttackAngle(°),TimeToContact(s),参考ヘッドスピード(km/h),コメント\n";
  document.querySelectorAll("#blastTable tbody tr").forEach(row=>{
    const cols = row.querySelectorAll("td");
    const name = cols[0].querySelector("input").value;
    const bs = cols[1].querySelector("input").value;
    const aa = cols[2].querySelector("input").value;
    const ttc = cols[3].querySelector("input").value;
    const ref = cols[4].textContent;
    const com = cols[5].textContent.replace(/,/g,"、");
    csv += `${name},${bs},${aa},${ttc},${ref},"${com}"\n`;
  });
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "blast_record.csv";
  link.click();
}
</script>
</body>
</html>
